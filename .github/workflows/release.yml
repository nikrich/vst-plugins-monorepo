name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    name: Build & Release Limiter + Reverb (macOS)
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show Xcode info
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Configure Limiter (Xcode)
        run: |
          rm -rf src/HungryGhostLimiter/build
          cmake -S src/HungryGhostLimiter -B src/HungryGhostLimiter/build -G Xcode

      - name: Configure Reverb (Xcode)
        run: |
          rm -rf src/HungryGhostReverb/build
          cmake -S src/HungryGhostReverb -B src/HungryGhostReverb/build -G Xcode

      - name: Configure Saturation (Xcode)
        run: |
          rm -rf src/HungryGhostSaturation/build
          cmake -S src/HungryGhostSaturation -B src/HungryGhostSaturation/build -G Xcode

      - name: Build Limiter (Release)
        run: |
          cmake --build src/HungryGhostLimiter/build --config Release --target HungryGhostLimiter_VST3

      - name: Build Reverb (Release)
        run: |
          cmake --build src/HungryGhostReverb/build --config Release --target HungryGhostReverb_VST3

      - name: Build Saturation (Release)
        run: |
          cmake --build src/HungryGhostSaturation/build --config Release --target HungryGhostSaturation_VST3

      - name: Package Limiter VST3
        id: pkg_limiter
        run: |
          set -euo pipefail
          ART_DIR="src/HungryGhostLimiter/build/HungryGhostLimiter_artefacts/Release/VST3"
          VST3_PATH=$(find "$ART_DIR" -type d -name "*.vst3" -print -quit)
          OUT_ZIP="HungryGhostLimiter-vst3-macos-${GITHUB_REF_NAME}.zip"
          ditto -c -k --sequesterRsrc --keepParent "$VST3_PATH" "$OUT_ZIP"
          echo "zip=$OUT_ZIP" >> $GITHUB_OUTPUT

      - name: Package Reverb VST3
        id: pkg_reverb
        run: |
          set -euo pipefail
          ART_DIR="src/HungryGhostReverb/build/HungryGhostReverb_artefacts/Release/VST3"
          VST3_PATH=$(find "$ART_DIR" -type d -name "*.vst3" -print -quit)
          OUT_ZIP="HungryGhostReverb-vst3-macos-${GITHUB_REF_NAME}.zip"
          ditto -c -k --sequesterRsrc --keepParent "$VST3_PATH" "$OUT_ZIP"
          echo "zip=$OUT_ZIP" >> $GITHUB_OUTPUT

      - name: Package Saturation VST3
        id: pkg_saturation
        run: |
          set -euo pipefail
          ART_DIR="src/HungryGhostSaturation/build/HungryGhostSaturation_artefacts/Release/VST3"
          VST3_PATH=$(find "$ART_DIR" -type d -name "*.vst3" -print -quit)
          OUT_ZIP="HungryGhostSaturation-vst3-macos-${GITHUB_REF_NAME}.zip"
          ditto -c -k --sequesterRsrc --keepParent "$VST3_PATH" "$OUT_ZIP"
          echo "zip=$OUT_ZIP" >> $GITHUB_OUTPUT

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Hungry Ghost Plugins ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            ${{ steps.pkg_limiter.outputs.zip }}
            ${{ steps.pkg_reverb.outputs.zip }}
            ${{ steps.pkg_saturation.outputs.zip }}
