name: CI

on:
  pull_request:
    branches: [ main ]
    paths:
      - src/HungryGhostLimiter/**
      - src/HungryGhostReverb/**
      - src/HungryGhostSaturation/**
      - src/HungryGhostMultibandCompressor/**
      - src/CommonUI/**
      - src/HungryGhostMultibandLimiter/**
      - vendor/JUCE/**
      - assets/**
      - .github/workflows/ci.yml
  push:
    branches: [ main ]
    paths:
      - src/HungryGhostLimiter/**
      - src/HungryGhostReverb/**
      - src/HungryGhostSaturation/**
      - src/HungryGhostMultibandLimiter/**
      - src/HungryGhostMultibandCompressor/**
      - src/CommonUI/**
      - vendor/JUCE/**
      - assets/**
      - .github/workflows/ci.yml
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-limiter:
    name: Build & Test HungryGhostLimiter (macOS)
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode info
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Configure HungryGhostLimiter (Xcode generator)
        run: |
          rm -rf src/HungryGhostLimiter/build
          cmake -S src/HungryGhostLimiter -B src/HungryGhostLimiter/build -G Xcode

      - name: Build tests (Debug)
        run: |
          cmake --build src/HungryGhostLimiter/build --config Debug --target HGLTests_DSP HGLTests_Proc

      - name: Run tests (DSP)
        run: |
          ./src/HungryGhostLimiter/build/HGLTests_DSP_artefacts/Debug/HGLTests_DSP

      - name: Run tests (Processor)
        run: |
          ./src/HungryGhostLimiter/build/HGLTests_Proc_artefacts/Debug/HGLTests_Proc

      - name: Build plugin (Release)
        run: |
          cmake --build src/HungryGhostLimiter/build --config Release --target HungryGhostLimiter_VST3

      - name: Upload plugin artefacts (VST3 Bundle)
        uses: actions/upload-artifact@v4
        with:
          name: HungryGhostLimiter-vst3-macos
          path: |
            src/HungryGhostLimiter/build/HungryGhostLimiter_artefacts/Release/VST3/**/*.vst3
            src/HungryGhostLimiter/build/HungryGhostLimiter_artefacts/Release/VST3/**/*.vst3/**

  build-reverb:
    name: Build HungryGhostReverb (macOS)
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Show Xcode info
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Configure HungryGhostReverb (Xcode generator)
        run: |
          rm -rf src/HungryGhostReverb/build
          cmake -S src/HungryGhostReverb -B src/HungryGhostReverb/build -G Xcode

      - name: Build plugin (Release)
        run: |
          cmake --build src/HungryGhostReverb/build --config Release --target HungryGhostReverb_VST3

      - name: Upload plugin artefacts (VST3 Bundle)
        uses: actions/upload-artifact@v4
        with:
          name: HungryGhostReverb-vst3-macos
          path: |
            src/HungryGhostReverb/build/HungryGhostReverb_artefacts/Release/VST3/**/*.vst3
            src/HungryGhostReverb/build/HungryGhostReverb_artefacts/Release/VST3/**/*.vst3/**


  build-saturation:
    name: Build HungryGhostSaturation (macOS)
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode info
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Configure HungryGhostSaturation (Xcode generator)
        run: |
          rm -rf src/HungryGhostSaturation/build
          cmake -S src/HungryGhostSaturation -B src/HungryGhostSaturation/build -G Xcode

      - name: Build plugin (Release)
        run: |
          cmake --build src/HungryGhostSaturation/build --config Release --target HungryGhostSaturation_VST3

      - name: Upload plugin artefacts (VST3 Bundle)
        uses: actions/upload-artifact@v4
        with:
          name: HungryGhostSaturation-vst3-macos
          path: |
            src/HungryGhostSaturation/build/HungryGhostSaturation_artefacts/Release/VST3/**/*.vst3
            src/HungryGhostSaturation/build/HungryGhostSaturation_artefacts/Release/VST3/**/*.vst3/**

  build-multiband-compressor:
    name: Build & Test Multiband Compressor (macOS)
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode info
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Configure HungryGhostMultibandCompressor (Xcode generator)
        run: |
          rm -rf src/HungryGhostMultibandCompressor/build
          cmake -S src/HungryGhostMultibandCompressor -B src/HungryGhostMultibandCompressor/build -G Xcode

      - name: Build tests (Debug)
        run: |
          cmake --build src/HungryGhostMultibandCompressor/build --config Debug --target HGMBCTests_DSP

      - name: Run tests (MBC DSP)
        run: |
          ./src/HungryGhostMultibandCompressor/build/HGMBCTests_DSP_artefacts/Debug/HGMBCTests_DSP

      - name: Build plugin (Release)
        run: |
          cmake --build src/HungryGhostMultibandCompressor/build --config Release --target HungryGhostMultibandCompressor_VST3

      - name: Upload plugin artefacts (VST3 Bundle)
        uses: actions/upload-artifact@v4
        with:
          name: HungryGhostMultibandCompressor-vst3-macos
          path: |
            src/HungryGhostMultibandCompressor/build/HungryGhostMultibandCompressor_artefacts/Release/VST3/**/*.vst3
            src/HungryGhostMultibandCompressor/build/HungryGhostMultibandCompressor_artefacts/Release/VST3/**/*.vst3/**


  build-multiband-limiter:
    name: Build & Test Multiband Limiter (macOS)
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode info
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Configure HungryGhostMultibandLimiter (Xcode generator)
        run: |
          rm -rf src/HungryGhostMultibandLimiter/build
          cmake -S src/HungryGhostMultibandLimiter -B src/HungryGhostMultibandLimiter/build -G Xcode

      - name: Build tests (Debug)
        run: |
          cmake --build src/HungryGhostMultibandLimiter/build --config Debug --target HGMBLTests_DSP

      - name: Run tests (DSP)
        run: |
          ./src/HungryGhostMultibandLimiter/build/HGMBLTests_DSP_artefacts/Debug/HGMBLTests_DSP

      - name: Build plugin (Release)
        run: |
          cmake --build src/HungryGhostMultibandLimiter/build --config Release --target HungryGhostMultibandLimiter_VST3

      - name: Upload plugin artefacts (VST3 Bundle)
        uses: actions/upload-artifact@v4
        with:
          name: HungryGhostMultibandLimiter-vst3-macos
          path: |
            src/HungryGhostMultibandLimiter/build/HungryGhostMultibandLimiter_artefacts/Release/VST3/**/*.vst3
            src/HungryGhostMultibandLimiter/build/HungryGhostMultibandLimiter_artefacts/Release/VST3/**/*.vst3/**
